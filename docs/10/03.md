# 3. Criteria

- Criteria 쿼리는 JPQL을 자바 코드로 작성하도록 도와주는 빌더 클래스 API다.
- 장점으로는 문법 오류를 컴파일 단계에서 잡을 수 있다는 점과 동적 쿼리를 안전하게 생성할 수 있다는 점이 있다.
- 단점으로는 코드가 복잡하고 장황해서 직관적으로 이해가 힘들다는 점이 있다.

## 3.1 Criteria 기초

- `javax.persistence.criteria` 패키지에 있다.

```
// JPQL: select m from Member
CriteriaBuilder cb = em.getCriteriaBuilder();   // Criteria 쿼리 빌더 - 1

// Criteria 생성, 반환 타입 지정 - 2
CriteriaQuery<Member> cq = cb.createQuery(Member.class);

Root<Member> m = cq.from(Member.class); // FROM 절 - 3
cq.select(m);   // SELECT 절 - 4

TypedQuery<Member> query = em.createQuery(cq);
List<Member> members = query.getResultList();
``` 

- 모든 회원 엔티티를 조회하는 단순한 JPQL을 Criteria로 작성해본다.
    1. Criteria 빌더를 얻는다. `EntityManager`나 `EntityManagerFactory`에서 얻을 수 있다.
    2. Criteria 쿼리 빌더에서 Criteria 쿼리를 생성한다. 반환 타입을 지정할 수 있다.
    3. FROM 절을 생성한다. 반환된 값 `m`은 Criteria에서 사용하는 별칭이다. `m`을 조회의 시작이라는 의미로 루트라 한다.
    4. SELECT 절을 생성한다.
- Criteria 쿼리를 완성하고 나면 다음 순서는 JPQL과 같다.
- `em.createQuery(cq)`에 완성된 Criteria 쿼리를 넣어주면 된다.

```
// JPQL
// select m from Member m
// where m.username='회원1'
// order by m.age desc

CriteriaBuilder cb = em.getCriteriaBuilder();

CriteriaQuery<Member> cq = cb.createQuery(Member.class);

Root<Member> m = cq.from(Member.class); // FROM 절 생성

// 검색 조건 정의 - 1
Predicate usernameEqual = cb.equal(m.get("username"), "회원1");

// 정렬 조건 정의 - 2
javax.persistence.criteria.Order ageDesc = cb.desc(m.get("age"));

// 쿼리 생성 - 3
cq.select(m)
    .where(usernameEqual)   // WHERE 절 생성
    .orderBy(ageDesc);      // ORDER BY 절 생성
    
List<Member> resultList = em.createQuery(cq).getResultList();
```

- 이전에 보았던 쿼리에 검색 조건과 정렬 조건을 추가했다.
    1. `m`은 회원 엔티티의 별칭이다.
        - `m.get("username")`은 `m.username`과 같은 표현이다.
        - `cb.equal(A, B)`는 `A = B`라는 뜻이다. `cb.equal(m.get("username"), "회원1")`은 `m.username = '회원1'`과 같다.
    2. 정렬 조건을 정의하는 코드인 `cb.desc(m.get("age"))`는 `m.age desc`와 같은 표현이다.
    3. 만들어둔 조건을 `where`, `orderBy`에 넣어서 원하는 쿼리를 생성한다.
- Criteria는 검색 조건부터 정렬까지 `CriteriaBuilder`를 사용해서 코드를 완성한다.
- 쿼리 루트(Qeury Root)와 별칭을 알아본다.
    - `Root<Member> m = cq.from(Member.class)`: 여기서 `m`이 쿼리 루트다.
    - 쿼리 루트는 조회의 시작점이다.
    - Criteria에서 사용되는 특별한 별칭이다. JPQL의 별칭과 같다.
    - 별칭은 엔티티에만 부여할 수 있다.
- Criteria는 코드로 JPQL을 완성하는 도구다. 따라서 경로 표현식이 있다.
    - `m.get("username")`는 `m.username`과 같다.
    - `m.get("team").get("name")`는 `m.team.name`과 같다.

```
// select m from Member m
// where m.age > 10 order by m.age desc

Root<Member> m = cq.from(Member.class);

// 타입 정보 필요
Predicate ageGt = cb.greaterThan(m.<Integer>get("age"), 10);

// 쿼리 생성 - 3
cq.select(m)
cq.where(ageGt);
cq.orderBy(cb.desc(m.get("age")));
```

- `m.<Integer>get("age")`에서 제네릭으로 타입 정보를 준다.
- 이는 `m.get("age")`만으로는 타입 정보를 알지 못하므로 반환 타입 정보를 명시해야 한다.
- `greaterThan()` 대신 `gt()`를 사용해도 된다.


## 3.2 Criteria 쿼리 생성

- Criteria를 사용하려면 `CriteriaBuilder.createQuery()` 메서드로 쿼리를 생성하면 된다.
- Criteria 쿼리를 생성할 때 파라미터로 쿼리 결과에 대한 반환 타입을 미리 지정할 수 있다.

```
CriteriaBuilder cb = em.getCriteriaBuilder();

// Member를 반환 타입으로 지정
CriteriaQuery<Member> cq = cb.createQuery(Member.class);

// ...

// 위에서 Member 타입을 지정해서 Member 타입을 바로 반환
List<Member> resultList = em.createQuery(cq).getResultList();
```

- 반환 타입을 지정할 수 없거나 반환 타입이 둘 이상이면 타입을 지정하지 않고 `Object`로 반환받아도 된다.

```
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Object> cq = cb.createQuery();    // 조회값 반환 타입: Object
// ...
List<Object> resultList = em.createQuery(cq).getResultList();
```

- 반환 타입이 둘 이상이면 Object[]를 사용하는 것이 편리하다.

```
CriteriaBuilder cb = em.getCriteriaBuilder();

// 조회값 반환 타입: Object[]
CriteriaQuery<Object[]> cq = cb.createQuery(Object[].class);
// ...
List<Object> resultList = em.createQuery(cq).getResultList();
```

- 반환 타입을 튜플로 받고 싶으면 튜플을 사용해도 된다.

```
CriteriaBuilder cb = em.getCriteriaBuilder();

// 조회값 반환 타입: Tuple
CriteriaQuery<Tuple> cq = cb.createTupleQuery();
// ...
TypedQuery<Tuple> query = em.createQeury(cq);
```

-----
[Home](./index.md)
